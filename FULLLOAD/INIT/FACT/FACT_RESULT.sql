use test

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE OR ALTER PROCEDURE [dbo].[INIT_FACT_RESULT]

AS
BEGIN

SET NOCOUNT ON;
SET XACT_ABORT ON;

------------------------------------------------------------------------------------
-- Bắt đầu Transaction
BEGIN TRAN;
BEGIN TRY;

IF EXISTS(SELECT * FROM sys.tables WHERE SCHEMA_NAME(schema_id) LIKE 'dbo' AND name like 'FACT_RESULT')
   DROP TABLE test.dbo.FACT_RESULT

CREATE TABLE test.dbo.FACT_RESULT (
	STARTED_DATE_KEY             BIGINT ,
    STARTED_TIME_KEY             INT,
    ANSWERED_DATE_KEY            BIGINT ,
    ANSWERED_TIME_KEY            INT,
    DEACTIVATED_DATE_KEY         BIGINT ,
    DEACTIVATED_TIME_KEY         INT,
    USER_ID                      INT,
    QUESTION_ID                  INT,
    QUESTION_TYPE                NVARCHAR(50),
    GROUP_NAME_KEY               INT,
    GROUP_NAME_LABEL             NVARCHAR(50),
    TRACK_NAME_KEY               INT,
    TRACK_NAME_LABEL             NVARCHAR(50),
    SUBTRACKNAME_KEY             INT,
    SUBTRACKNAME_LABEL           NVARCHAR(50),
    NUM_PLAYERS                  INT,
    QUESTION_SET_ID              INT,
    OUTCOME_KEY                  INT,
    SCORE                        INT,
)

ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_STARTED_DATE_KEY FOREIGN KEY (STARTED_DATE_KEY) REFERENCES DIM_DATE(DATE_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_STARTED_TIME_KEY FOREIGN KEY (STARTED_TIME_KEY) REFERENCES DIM_TIME(TIME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_ANSWERED_DATE_KEY FOREIGN KEY (ANSWERED_DATE_KEY) REFERENCES DIM_DATE(DATE_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_ANSWERED_TIME_KEY FOREIGN KEY (ANSWERED_TIME_KEY) REFERENCES DIM_TIME(TIME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_DEACTIVATED_DATE_KEY FOREIGN KEY (DEACTIVATED_DATE_KEY) REFERENCES DIM_DATE(DATE_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_DEACTIVATED_TIME_KEY FOREIGN KEY (DEACTIVATED_TIME_KEY) REFERENCES DIM_TIME(TIME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_GROUP_NAME_KEY FOREIGN KEY (GROUP_NAME_KEY) REFERENCES DIM_GROUP_NAME(GROUP_NAME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_TRACK_NAME_KEY FOREIGN KEY (TRACK_NAME_KEY) REFERENCES DIM_TRACKNAME(TRACKNAME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_SUBTRACK_NAME_KEY FOREIGN KEY (SUBTRACKNAME_KEY) REFERENCES DIM_SUB_TRACKNAME(SUBTRACKNAME_KEY);
ALTER TABLE dbo.FACT_RESULT
ADD CONSTRAINT FK_OUTCOME_KEY FOREIGN KEY (OUTCOME_KEY) REFERENCES DIM_OUTCOME(OUTCOME_KEY);


-- COMMIT HANDLE DATA
COMMIT
RETURN 0
END TRY
BEGIN CATCH
	ROLLBACK
	DECLARE @ERRORMESSAGE NVARCHAR(2000)
	SELECT @ERRORMESSAGE = 'ERROR: ' + ERROR_MESSAGE()
	RAISERROR(@ERRORMESSAGE, 16, 1)
END CATCH

-- Kết thúc Transaction
------------------------------------------------------------------------------------
END

EXEC [dbo].[INIT_FACT_RESULT]
GO
